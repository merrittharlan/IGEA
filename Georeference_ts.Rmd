---
title: "Georeference Total Station"
author: "Merritt Harlan"
date: "8/3/2021"
output: html_document
---

## Correct Total Station Data with GPS data
Adapted from https://gist.github.com/troyhill/2c461cfaaeddf9dcf0fd

```{r process, echo=TRUE}
ts_data = read.csv("8_3_Total_Station_Points.csv")
head(ts_data)

etrex_data = read.csv("waypoints_03-AUG-21.csv")
head(etrex_data)

```

```{r functions, echo=TRUE}
# this function generates a transform matrix:
# If "unknownData" object doesn't have columns 
# named "Code", "Ground.Northing..m." and "Ground.Easting..m.",
# insert those column names as 'y.unk' and 'x.unk'
genTransform <- function(knownData = knowns, y.col = "y", x.col = "x", 
                         unknownData = SETpoints, y.unk = "Ground.Northing..m.", x.unk = "Ground.Easting..m.", 
                         n = 3) {
  
  # if user provides more than three points with known coordinates, 
  # use the first three found in both datasets
  tiePoints <- c(as.character(knownData$Code[knownData$Code %in% unknownData$Code])[1:n])

  # re-format to get the datasets in the same order
  data <- knownData[knownData$Code %in% tiePoints, ]
  data$fill.col <- 1
  data$x.un <- data$y.un <- NA
  for (i in 1:nrow(data)) {
    data$y.un[i] <- unknownData[unknownData$Code %in% tiePoints[i], y.unk]
    data$x.un[i] <- unknownData[unknownData$Code %in% tiePoints[i], x.unk]
  }
  print(noquote(c("Used the following control points: ", paste0(data$Code[1:n], collapse = ", "))))
  # get known coordinates
  k <- as.matrix(data[c(x.col, y.col, "fill.col")])
  u <- as.matrix(data[c("x.un", "y.un", "fill.col")])
  
  A <- t(solve(u, k)) # this matches matlab output 'A'
}

```

```{r functions2, echo=TRUE}
# function to convert between coordinate systems
# be careful that transform matrix and NEunknowns have the same order of northings/eastings
# inputData: dataset to append to
# transformMatrix: matrix used for conversion, generated by genTransform()
# xyPoints: unknown x/y points - it's very important that these appear in the order x, y
# colNames: a vector of strings containing names of columns to append
coordConv <- function (inputData, transformMatrix, xyPoints, colNames) {
  # add columns to receive data
  inputData[, colNames[2]] <- inputData[, colNames[1]] <- NA
  
  xyPoints$fill.col <- 1
  if (!nrow(xyPoints) == 1) {
      for (i in 1:nrow(xyPoints)) {
        outputTemp <- transformMatrix %*% as.numeric(xyPoints[i, ])
        inputData[i, colNames[1]] <- outputTemp[1]
        inputData[i, colNames[2]] <- outputTemp[2]
      }    
  } else { 
    outputTemp <- transformMatrix %*% as.numeric(xyPoints)
    inputData[colNames[1]] <- outputTemp[1]
    inputData[colNames[2]] <- outputTemp[2]
  }
  
  inputData
}

```

